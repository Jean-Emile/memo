#!/usr/bin/env python3

import os
import subprocess
import sys
import platform

arch, osyst, comp = os.environ['BUILDFARM_NAME'].split('-')

template = '''\
#!/usr/bin/env python3

import os
import sys

# Add drake in the Python path.
sys.path.insert(0, os.path.realpath(%(dir_source)r '/elle/drake/src'))


import drake
import drake.cxx

os.environ.update(%(environ)r)

cxx_toolkit = drake.cxx.GccToolkit(compiler = %(compiler)r)

cfg = drake.cxx.Config()
cfg.enable_debug_symbols()
cfg.enable_optimization()

for f in %(flags)r:
  cfg.flag(f)

with drake.Drake(%(dir_source)r) as d:
  d.run(cxx_toolkit = cxx_toolkit,
        cxx_config = cfg,
        fuse = %(fuse)r,
        python = %(python)r,
        valgrind = %(valgrind)r,
        beyond = %(beyond)r)
'''

parameters = {
  'compiler': None,
  'environ': {},
  'flags': (),
  'fuse': None,
  'python': None,
  'valgrind': None,
}

with open('%s/drake' % os.environ['DIR_BUILD'], 'w') as drake:
  parameters['dir_source'] = os.path.abspath(os.environ['DIR_SOURCE'])
  if osyst == 'osx':
    parameters['compiler'] = 'g++-4.9'
    parameters['environ'] = {
      'MACOSX_DEPLOYMENT_TARGET': '10.7',
      'PATH': os.environ['PATH'] + ':/usr/local/Cellar/gcc49/4.9.3/bin/'
      }
    parameters['flags'] = ('-ftemplate-depth=512',)
    parameters['python'] = \
      '/usr/local/Frameworks/Python.framework/Versions/3.4'
    parameters['valgrind'] = False
  parameters['beyond'] = 'ubuntu' in osyst

  content = template % parameters
  print(content, file = drake)
  print(content)
