<%!
def type(proto, elem):
  '''
  Add the optional rule (e.g. repated) before the type and a link if the
  type is defined by us.
  '''
  res = ''
  if elem.get('rule'):
    res = '%s ' % elem['rule']
  if elem['type'] in map(lambda x: x['name'], proto['messages']):
    return res + '<a href="#%(type)s">%(type)s</a>' % {'type': elem['type']}
  return res + elem['type']
%>

<%inherit file="/base.html"/>

<%block name="content">
  
  <%include file='menu.html'/>

   <nav class="side-menu" id="page-menu">
    <div id="menu-anchor"></div>

    <ul class="tier1">
      <li class="title"><strong>Page Contents</strong></li>
      <li class="methods">
        <a href="#methods">Methods</a></li>
        <ul>
          % for method in proto['service']['rpcs']:
            <li class="${method['name']}"><a href="#${method['name']}">${method['name']}</a></li>
          % endfor
        </ul>
      </li>
      <li class="messages">
        <a href="#messages">Messages</a>
        <ul>
          % for message in proto['messages']:
            <li class="${message['name']}"><a href="#${message['name']}">${message['name']}</a></li>
          % endfor
        </ul>
      </li>
    </ul>
  </nav>

  <section class="doc">
    <h1>API Reference</h1>

    <p>A comprehensive reference guide to the complete key-value store API.</p>

    <h2 id="methods">Methods</h2>

    <p>Find the documentation of all methods used in the key-value store API.</p>

    % for method in proto['service']['rpcs']:
      
      <table class="method">
        <tr>
          <th colspan="2">
            <h3 id="${method['name']}">${method['name']}</h3>
            <p><em>${method['documentation']['abstract']}</em></p>
          </th>
        </tr>
        <tr>
          <td><strong>returns</strong></td>
          <td><code><a href="#${method['returns']}">${method['returns']}</a></code></td>
        </tr>
        <tr>
          <td><strong>arguments</strong></td>
          <td><code>${' '.join(["<a href='#%(arg)s'>%(arg)s</a>" % {"arg": arg} for arg in method['arguments']])}</code></td>
        </tr>
      </table>

      % for doc in ['description', 'related', 'specific']:
        % if method.get('documentation', {}).get(doc):
          <p>${method['documentation'][doc]}.</p>
        % endif
      % endfor
    % endfor

    <h2 id="messages">Messages</h2>

    % for message in proto['messages']:

      
      <table class="message">
        <tr>
          <th colspan="4">
            <h3 id="${message['name']}">${message['name']}</h3>
          </th>
        </tr>
        <tr>
          <td width="10%">index</td>
          <td>name</td>
          <td>type</td>
          <td>abstract</td>
        </tr>
        % for attr in message.get('attributes', []):
          <tr>
            % if attr['type'] == 'oneof':
              <td colspan=1>${attr['name']}<td>
              <td>${type(proto, attr)}</td>
              <td>${attr.get('documentation', {}).get('abstract', '')}</td>
              % for subattr in attr['values']:
                <tr>
                  <td>${subattr['index']}</td>
                  <td>${subattr['name']}</td>
                  <td>${type(proto, subattr)}</td>
                  <td>${subattr.get('documentation', {}).get('abstract', '')}</td>
                </tr>
              % endfor
            % else:
              <td>${attr['index']}</td>
              <td>${attr['name']}</td>
              <td>${type(proto, attr)}</td>
              <td>${attr.get('documentation', {}).get('abstract', '')}</td>
            % endif
          </tr>
        % endfor
      </table>
    % endfor
  </section>

</%block>