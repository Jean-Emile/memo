#! /usr/bin/env python

import argparse
import re
import subprocess

objects = [
    'acl',
    'block',
    'credentials',
    'daemon',
    'device',
    'doctor',
    'drive',
    'journal',
    'network',
    'passport',
    'silo',
    'user',
    'volume',
    ]

def getargs():
    p = argparse.ArgumentParser()
    p.add_argument('infinit',
                   type=str, default='infinit',
                    help='Infinit binary.')
    p.add_argument('--base', default='',
                   help='base name for output files')
    p.add_argument('--legacy', action='store_true',
                   help='whether running the legacy interface')
    return p.parse_args()

args = getargs()

def get_help(obj, mode=None):
    if mode and args.legacy:
        m = '--{}'.format(mode)
    elif mode:
        m = mode
    else:
        m = ''
    cmd = '{}-{} {} --help'.format(args.infinit, obj, m).split()
    return subprocess.check_output(cmd).decode('utf-8')

def get_modes(obj):
    try:
        modes = re.findall(r'^Modes:\n(.*?)\n\n', get_help(obj), re.DOTALL | re.MULTILINE)[0]
        # Exactly two leading spaces, to avoid catching wrapped help messages.
        return re.findall(r'^  (?:--)?(\w+) ', modes, re.MULTILINE)
    except:
        raise RuntimeError('cannot read modes for {}'.format(obj))

for obj in objects:
    if args.legacy and obj == 'silo':
        o = 'storage'
    else:
        o = obj
    fn = '{}{}'.format(args.base, obj)
    with open(fn, 'w') as out:
        print(get_help(o), file=out)
    for m in get_modes(o):
        fn = '{}{}-{}'.format(args.base, obj, m)
        with open(fn, 'w') as out:
            print("{}: {}: {}".format(o, m, get_help(o, m)),
                  file=out)
